<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Гамшгийн Аюулаас Хамгаалах Хичээл</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Цайвар цэнхэр саарал фон */
        }
        .video-responsive {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 харьцаа */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background-color: #000;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .video-responsive iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .lesson-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .lesson-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .emergency-kit-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }
        .emergency-kit-item:hover {
            background-color: #e2e8f0;
        }

        /* --- Уулын тоглоомын CSS --- */
        .game-area-container { /* Тоглоомын гаднах контейнер */
            background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1519681393784-a93987cb0f74?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1470&q=80'); /* Шинэ уулын зураг + хагас тунгалаг давхарга */
            background-size: cover;
            background-position: center;
            position: relative;
            min-height: 500px; /* Өндрийг нэмэгдүүлсэн */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white; /* Текстний өнгийг цагаан болгосон */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5); /* Текстэнд сүүдэр нэмсэн */
        }
        .game-area-container h3, .game-area-container p {
            color: white; /* Тоглоомын доторх текст цагаан байна */
        }

        /* Loading overlay style for Game */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* Илүү цайвар болгосон */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            border-radius: 0.75rem;
            color: #333; /* Текстний өнгө */
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Altitude Bar Gradient */
        /* Vertical bar will use height-based gradient */
        #altitude-bar {
            background: linear-gradient(to top, #ef4444, #dc2626); /* Default Red gradient, now vertical */
            width: 100%; /* Should fill its parent horizontally */
            transition: height 0.5s ease-out, background 0.5s ease; /* Transition for height and background */
        }

        #altitude-bar.bg-red-500 {
            background: linear-gradient(to top, #ef4444, #dc2626); /* Red gradient */
        }
        #altitude-bar.bg-yellow-500 {
            background: linear-gradient(to top, #facc15, #eab308); /* Yellow gradient */
        }
        #altitude-bar.bg-green-500 {
            background: linear-gradient(to top, #22c55e, #16a34a); /* Green gradient */
        }


        /* Question & Options Styling */
        #question-display {
            background-color: rgba(255, 255, 255, 0.9); /* Хагас тунгалаг цагаан */
            color: #333; /* Текстний өнгө */
            border-radius: 1rem; /* Илүү бөөрөнхий */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Сүүдэр */
        }
        #question-display p {
            color: #333; /* Асуултын текст */
        }
        #options-container button {
            background-color: #60a5fa; /* Blue-400 */
            border: none;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #options-container button:hover {
            background-color: #3b82f6; /* Blue-500 */
            transform: translateY(-2px);
        }

        /* Feedback Styling */
        #feedback-display {
            font-size: 1.1rem; /* Томруулсан */
            padding: 1rem;
            border-radius: 0.75rem;
            animation: fadeInOut 2s forwards; /* Animation added */
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        
        #save-status-display {
            animation: fadeInOut 3s forwards;
        }

        /* Start Button Animation */
        #start-button {
            background: linear-gradient(to right, #3b82f6, #2563eb); /* Blue gradient */
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        #start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        #start-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.3);
            transform: skewX(-30deg);
            transition: all 0.5s ease;
        }
        #start-button:hover::before {
            left: 100%;
        }

        /* Climber Dot Styling (updated for vertical track) */
        #climber-dot {
            position: absolute;
            left: 50%; /* Center horizontally within its track */
            transform: translateX(-50%);
            width: 40px; /* Slightly larger for visibility */
            height: 40px;
            background-color: rgba(252, 165, 165, 0.8); /* Pinkish-red, slightly transparent */
            border-radius: 50%;
            border: 2px solid white;
            transition: bottom 1.5s ease-out; /* Smooth transition for vertical movement */
            z-index: 50; /* Above the bar */
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.7);
            font-size: 1.6rem; /* Make icon larger */
            display: flex;
            justify-content: center;
            align-items: center;
            color: white; /* Icon color */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* Text shadow for icon */
        }

        /* --- Chatbot CSS --- */
        .chat-container {
            height: 500px; /* Чатын түүхний өндөр */
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background-color: #ffffff;
        }
        .chat-message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }
        .user-message {
            align-self: flex-end;
            background-color: #bfdbfe; /* blue-200 */
            color: #1e40af; /* blue-800 */
            border-bottom-right-radius: 0.25rem;
        }
        .bot-message {
            align-self: flex-start;
            background-color: #dbeafe; /* blue-100 */
            color: #1e3a8a; /* blue-900 */
            border-bottom-left-radius: 0.25rem;
        }
        .chatbot-input-area {
            display: flex;
            margin-top: 1rem;
            gap: 0.5rem;
        }
        .chatbot-loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
            align-self: center;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-shield-alt text-2xl"></i>
                <a href="#" class="text-2xl font-bold hover:text-blue-100 transition duration-300">
                    Гамшгийн Аюулаас Хамгаалах
                </a>
            </div>
            
            <!-- Desktop Navigation -->
            <nav class="hidden md:flex space-x-2">
                <a href="#lessons" class="px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center">
                    <i class="fas fa-book mr-2"></i> Хичээлүүд
                </a>
                <a href="#game-section" class="px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center">
                    <i class="fas fa-gamepad mr-2"></i> Тоглоом
                </a>
                <a href="#game-results-section" class="px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center">
                    <i class="fas fa-chart-bar mr-2"></i> Үр дүнгүүд
                </a>
                <a href="#chatbot-section" class="px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center">
                    <i class="fas fa-comments mr-2"></i> Чатбот
                </a>
                <a href="#resources" class="px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center">
                    <i class="fas fa-link mr-2"></i> Нэмэлт Мэдээлэл
                </a>
                <a href="#about" class="px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center">
                    <i class="fas fa-info-circle mr-2"></i> Бидний тухай
                </a>
            </nav>
            
            <!-- Mobile Menu Button -->
            <button id="mobile-menu-button" class="md:hidden p-2 rounded-lg hover:bg-blue-700 focus:outline-none">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <nav id="mobile-menu" class="hidden md:hidden bg-blue-700 text-white">
        <div class="container mx-auto px-4 py-2 flex flex-col space-y-2">
            <a href="#lessons" class="px-4 py-3 rounded-lg hover:bg-blue-800 transition duration-300 flex items-center">
                <i class="fas fa-book mr-3"></i> Хичээлүүд
            </a>
            <a href="#game-section" class="px-4 py-3 rounded-lg hover:bg-blue-800 transition duration-300 flex items-center">
                <i class="fas fa-gamepad mr-3"></i> Тоглоом
            </a>
            <a href="#game-results-section" class="px-4 py-3 rounded-lg hover:bg-blue-800 transition duration-300 flex items-center">
                <i class="fas fa-chart-bar mr-3"></i> Үр дүнгүүд
            </a>
            <a href="#chatbot-section" class="px-4 py-3 rounded-lg hover:bg-blue-800 transition duration-300 flex items-center">
                <i class="fas fa-comments mr-3"></i> Чатбот
            </a>
            <a href="#resources" class="px-4 py-3 rounded-lg hover:bg-blue-800 transition duration-300 flex items-center">
                <i class="fas fa-link mr-3"></i> Нэмэлт Мэдээлэл
            </a>
            <a href="#about" class="px-4 py-3 rounded-lg hover:bg-blue-800 transition duration-300 flex items-center">
                <i class="fas fa-info-circle mr-3"></i> Бидний тухай
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- Hero Section -->
        <section class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl shadow-xl p-8 mb-12 text-center">
            <h1 class="text-4xl font-bold mb-4">Гамшгийн Аюулаас Хамгаалах Мэдлэг</h1>
            <p class="text-xl mb-6">Гамшгийн аюулын үед зөв арга хэмжээ авснаар та өөририйн болон хайртай хүмүүсийнхээ амь насыг аврах боломжтой</p>
            <a href="#lessons" class="inline-block bg-white text-blue-600 font-bold py-3 px-6 rounded-lg hover:bg-blue-100 transition duration-300">
                <i class="fas fa-play mr-2"></i> Хичээлүүдийг үзэх
            </a>
        </section>

        <!-- Lessons Section -->
        <section id="lessons" class="mb-16">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Гамшгийн аюулаас хамгаалах хичээлүүд</h2>
                <div class="w-24 h-1 bg-blue-500 mx-auto mb-6"></div>
                <p class="text-gray-600 max-w-3xl mx-auto mb-8">Доорх хичээлүүдийг ангилалаар нь сонгон судалж, өөрийгөө болон хайртай хүмүүсээ аюулаас хамгаалах аргад суралцаарай.</p>
                
                <div class="flex justify-center mb-8">
                    <div class="inline-flex rounded-md shadow-sm" role="group">
                        <button type="button" id="grade-btn-baga" data-grade="Бага анги" class="px-6 py-2 text-sm font-medium text-blue-700 bg-blue-100 rounded-l-lg hover:bg-blue-200 focus:z-10 focus:ring-2 focus:ring-blue-700">
                            Бага анги
                        </button>
                        <button type="button" id="grade-btn-dund" data-grade="Дунд анги" class="px-6 py-2 text-sm font-medium text-blue-700 bg-white hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-700">
                            Дунд анги
                        </button>
                        <button type="button" id="grade-btn-ahlah" data-grade="Ахлах анги" class="px-6 py-2 text-sm font-medium text-blue-700 bg-white rounded-r-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-700">
                            Ахлах анги
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lesson 1: Earthquake -->
            <div id="earthquake-lesson" class="bg-white rounded-xl shadow-md overflow-hidden mb-10 lesson-card">
                <div class="md:flex">
                    <div class="md:w-1/3">
                        <div class="h-full bg-gray-100 p-4 flex items-center justify-center">
                            <img src="https://images.unsplash.com/photo-1517365884913-3c33884b06fa?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1180&q=80"
                                  alt="Газар хөдлөлт"
                                  class="w-full h-auto rounded-lg object-cover">
                        </div>
                    </div>
                    <div class="md:w-2/3 p-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold mr-3">
                                Хичээл 1
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">Газар хөдлөлтөөс хэрхэн хамгаалах вэ?</h3>
                        </div>
                        
                        <div class="video-responsive mb-4" data-lesson-id="earthquake-lesson">
                            <!-- Video will be loaded by JavaScript -->
                            <iframe width="560" height="315" src="" title="Газар хөдлөлтийн аюулаас хамгаалах видео" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                        </div>
                        
                        <p class="text-gray-700 mb-4">Газар хөдлөлт нь гэнэт тохиолддог байгалийн гамшиг юм. Үүний үед хэрхэн зөв арга хэмжээ авах нь таны амь насыг аврахад чухал үүрэгтэй.</p>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                                    <i class="fas fa-check-circle mr-2"></i> Хийх ёстой зүйлс:
                                </h4>
                                <ul class="list-disc list-inside text-gray-700 space-y-1 pl-4">
                                    <li><strong>"Суу,нуугд,хүлээ"</strong> зарчмыг баримтлах</li>
                                    <li>Цонх, гадна хананаас хол байх</li>
                                    <li>Гадаа байвал задгай газар байх</li>                                    
                                    <li>Цахилгаан шат ашиглахгүй байх</li>
                                </ul>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-yellow-800 mb-2 flex items-center">
                                    <i class="fas fa-exclamation-triangle mr-2"></i> Анхаарах зүйлс:
                                </h4>
                                <ul class="list-disc list-inside text-gray-700 space-y-1 pl-4">
                                    <li>Эхний чичиргээн зогссоны дараа нүүлгэн шилжих</li>
                                    <li>Яаралтай тусламжийн цүнх бэлдэх</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-tasks mr-2 text-blue-500"></i> Дасгал даалгавар
                            </h4>
                            <div id="assignment-questions-earthquake" class="space-y-3 mb-4">
                                <!-- Даалгаврын асуултууд энд ачаална -->
                            </div>
                            <!-- Assign a class to this section for easy targeting -->
                            <div class="assignment-upload-section border-t border-gray-200 pt-4 mt-4">
                                <h5 class="font-semibold text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-upload mr-2 text-blue-500"></i> Бие даалтын даалгавар хураалгах
                                </h4>
                                <p class="text-gray-700 text-sm mb-3">Өөрийн даалгаврын файлыг энд хавсаргана уу (PDF, Word, эсвэл зураг).</p>
                                <input type="file" id="assignment-file-earthquake" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none mb-3">
                                <button id="submit-assignment-earthquake" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center">
                                    <i class="fas fa-paper-plane mr-2"></i> Даалгавар хураах
                                </button>
                                <div id="submission-status-earthquake" class="mt-2 text-sm text-gray-700 hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lesson 2: Flood -->
            <div id="flood-lesson" class="bg-white rounded-xl shadow-md overflow-hidden mb-10 lesson-card">
                <div class="md:flex">
                    <div class="md:w-1/3">
                        <div class="h-full bg-gray-100 p-4 flex items-center justify-center">
                            <img src="https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1074&q=80"
                                  alt="Үер"
                                  class="w-full h-auto rounded-lg object-cover">
                        </div>
                    </div>
                    <div class="md:w-2/3 p-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold mr-3">
                                Хичээл 2
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">Үерээс хэрхэн хамгаалах вэ?</h3>
                        </div>
                        
                        <div class="video-responsive mb-4" data-lesson-id="flood-lesson">
                            <!-- Video will be loaded by JavaScript -->
                            <iframe width="560" height="315" src="" title="Үерийн аюулаас хамгаалах видео" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                        </div>
                        
                        <p class="text-gray-700 mb-4">Үер нь их хэмжээний хур тунадас эсвэл мөс хайлснаас үүсдэг. Урьдчилан сэргийлэх, бэлэн байх нь маш чухал.</p>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                                    <i class="fas fa-check-circle mr-2"></i> Хийх ёстой зүйлс:
                                </h4>
                                <ul class="list-disc list-inside text-gray-700 space-y-1 pl-4">
                                    <li>Үерийн аюулын дохиог анхаарч сонсох</li>
                                    <li>Өндөрлөг газар руу нүүлгэн шилжих төлөвлөгөөтэй байх</li>
                                    <li>Үерийн усанд орохгүй байх</li>
                                    <li>Өндөр давхарт эсвэл дээвэр дээр гарах</li>
                                </ul>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-yellow-800 mb-2 flex items-center">
                                    <i class="fas fa-exclamation-triangle mr-2"></i> Анхаарах зүйлс:
                                </h4>
                                <ul class="list-disc list-inside text-gray-700 space-y-1 pl-4">
                                    <li>Цахилгааныг салгах</li>
                                    <li>Гамшгийн цүнхээ ойрхон авах бэлдэх</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-tasks mr-2 text-blue-500"></i> Дасгал даалгавар
                            </h4>
                            <div id="assignment-questions-flood" class="space-y-3 mb-4">
                                <!-- Даалгаврын асуултууд энд ачаална -->
                            </div>
                            <!-- Assign a class to this section for easy targeting -->
                            <div class="assignment-upload-section border-t border-gray-200 pt-4 mt-4">
                                <h5 class="font-semibold text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-upload mr-2 text-blue-500"></i> Бие даалтын даалгавар хураалгах
                                </h4>
                                <p class="text-gray-700 text-sm mb-3">Өөрийн даалгаврын файлыг энд хавсаргана уу (PDF, Word, эсвэл зураг).</p>
                                <input type="file" id="assignment-file-flood" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none mb-3">
                                <button id="submit-assignment-flood" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center">
                                    <i class="fas fa-paper-plane mr-2"></i> Даалгавар хураах
                                </button>
                                <div id="submission-status-flood" class="mt-2 text-sm text-gray-700 hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lesson 3: Fire -->
            <div id="fire-lesson" class="bg-white rounded-xl shadow-md overflow-hidden mb-10 lesson-card">
                <div class="md:flex">
                    <div class="md:w-1/3">
                        <div class="h-full bg-gray-100 p-4 flex items-center justify-center">
                            <img src="https://images.unsplash.com/photo-1512295767273-ac109ac3acfa?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=735&q=80"
                                  alt="Гал түймэр"
                                  class="w-full h-auto rounded-lg object-cover">
                        </div>
                    </div>
                    <div class="md:w-2/3 p-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold mr-3">
                                Хичээл 3
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">Гал түймрээс хэрхэн хамгаалах вэ?</h3>
                        </div>
                        
                        <div class="video-responsive mb-4" data-lesson-id="fire-lesson">
                            <!-- Video will be loaded by JavaScript -->
                            <iframe width="560" height="315" src="" title="Галын аюулаас урьдчилан сэргийлэх" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                        </div>
                        
                        <p class="text-gray-700 mb-4">Гал түймэр нь хүний амь нас, эд хөрөнгөнд асар их хохирол учруулдаг. Урьдчилан сэргийлэх, гарч болзошгүй аюулаас хамгаалах мэдлэгтэй байх нь чухал.</p>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                                    <i class="fas fa-check-circle mr-2"></i> Хийх ёстой зүйлс:
                                </h4>
                                <ul class="list-disc list-inside text-gray-700 space-y-1 pl-4">
                                    <li>Утааны дохиолол тавьж, байнга шалгах</li>
                                    <li>Галын аюулгүй байдлын төлөвлөгөөтэй байх</li>
                                    <li>Гал гарсан үед шууд галын хорыг ашиглах</li>
                                    <li>Түймэр гарсан байшинд эргэж орохгүй байх</li>
                                </ul>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-yellow-800 mb-2 flex items-center">
                                    <i class="fas fa-exclamation-triangle mr-2"></i> Анхаарах зүйлс:
                                </h4>
                                <ul class="list-disc list-inside text-gray-700 space-y-1 pl-4">
                                    <li>Бага насны хүүхдүүдэд галын аюулын талаар заавар өгөх</li>
                                    <li>Электроникийн хэрэгслийг зөв ашиглах</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-tasks mr-2 text-blue-500"></i> Дасгал даалгавар
                            </h4>
                            <div id="assignment-questions-fire" class="space-y-3 mb-4">
                                <!-- Даалгаврын асуултууд энд ачаална -->
                            </div>
                            <!-- Assign a class to this section for easy targeting -->
                            <div class="assignment-upload-section border-t border-gray-200 pt-4 mt-4">
                                <h5 class="font-semibold text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-upload mr-2 text-blue-500"></i> Бие даалтын даалгавар хураалгах
                                </h4>
                                <p class="text-gray-700 text-sm mb-3">Өөрийн даалгаврын файлыг энд хавсаргана уу (PDF, Word, эсвэл зураг).</p>
                                <input type="file" id="assignment-file-fire" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none mb-3">
                                <button id="submit-assignment-fire" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center">
                                    <i class="fas fa-paper-plane mr-2"></i> Даалгавар хураах
                                </button>
                                <div id="submission-status-fire" class="mt-2 text-sm text-gray-700 hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lesson 4: Blizzard -->
            <div id="blizzard-lesson" class="bg-white rounded-xl shadow-md overflow-hidden mb-10 lesson-card">
                <div class="md:flex">
                    <div class="md:w-1/3">
                        <div class="h-full bg-gray-100 p-4 flex items-center justify-center">
                            <img src="https://images.unsplash.com/photo-1483728642387-6c3bdd6c93e5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1176&q=80"
                                  alt="Цасан шуурга"
                                  class="w-full h-auto rounded-lg object-cover">
                        </div>
                    </div>
                    <div class="md:w-2/3 p-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold mr-3">
                                Хичээл 4
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">Цасан шуурганаас хэрхэн хамгаалах вэ?</h3>
                        </div>
                        
                        <div class="video-responsive mb-4" data-lesson-id="blizzard-lesson">
                            <!-- Video will be loaded by JavaScript -->
                            <iframe width="560" height="315" src="" title="Цасан шуурганы аюулаас хамгаалах видео" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                        </div>
                        
                        <p class="text-gray-700 mb-4">Цасан шуурга нь хүйтэн жавар, их хэмжээний цас, салхи шуурганаас үүсдэг. Өвлийн улиралд болзошгүй аюулаас урьдчилан сэргийлэх нь чухал.</p>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                                    <i class="fas fa-check-circle mr-2"></i> Хийх ёстой зүйлс:
                                </h4>
                                <ul class="list-disc list-inside text-gray-700 space-y-1 pl-4">
                                    <li>Цаг агаарын мэдээг тогтмол сонсох</li>
                                    <li>Гэртээ дулаан байлгах, нэмэлт хувцас бэлдэх</li>
                                    <li>Машиндаа үлдэж, тусламж хүлээнэ</li>
                                    <li>Хоол хүнс, усны нөөцтэй байх</li>
                                </ul>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-yellow-800 mb-2 flex items-center">
                                    <i class="fas fa-exclamation-triangle mr-2"></i> Анхаарах зүйлс:
                                </h4>
                                <ul class="list-disc list-inside text-gray-700 space-y-1 pl-4">
                                    <li>Цахилгаан тасарсан үед лаа, асаагуур бэлдэх</li>
                                    <li>Хүйтэнд хөлдөхөөс сэргийлэх</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-tasks mr-2 text-blue-500"></i> Дасгал даалгавар
                            </h4>
                            <div id="assignment-questions-blizzard" class="space-y-3 mb-4">
                                <!-- Даалгаврын асуултууд энд ачаална -->
                            </div>
                            <!-- Assign a class to this section for easy targeting -->
                            <div class="assignment-upload-section border-t border-gray-200 pt-4 mt-4">
                                <h5 class="font-semibold text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-upload mr-2 text-blue-500"></i> Бие даалтын даалгавар хураалгах
                                </h4>
                                <p class="text-gray-700 text-sm mb-3">Өөрийн даалгаврын файлыг энд хавсаргана уу (PDF, Word, эсвэл зураг).</p>
                                <input type="file" id="assignment-file-blizzard" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none mb-3">
                                <button id="submit-assignment-blizzard" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center">
                                    <i class="fas fa-paper-plane mr-2"></i> Даалгавар хураах
                                </button>
                                <div id="submission-status-blizzard" class="mt-2 text-sm text-gray-700 hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lesson 5: Emergency Kit -->
            <div id="emergency-kit-lesson" class="bg-white rounded-xl shadow-md overflow-hidden mb-10 lesson-card">
                <div class="md:flex">
                    <div class="md:w-1/3">
                        <div class="h-full bg-gray-100 p-4 flex items-center justify-center">
                            <img src="https://images.unsplash.com/photo-1573497491765-dccce02b29df?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=687&q=80"
                                  alt="Яаралтай тусламжийн цүнх"
                                  class="w-full h-auto rounded-lg object-cover">
                        </div>
                    </div>
                    <div class="md:w-2/3 p-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold mr-3">
                                Хичээл 5
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">Яаралтай тусламжийн цүнхэнд юу байх ёстой вэ?</h3>
                        </div>
                        
                        <div class="video-responsive mb-4" data-lesson-id="emergency-kit-lesson">
                            <!-- Video will be loaded by JavaScript -->
                            <iframe width="560" height="315" src="" title="Яаралтай тусламжийн цүнхний талаарх видео" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                        </div>
                        
                        <p class="text-gray-700 mb-4">Гамшгийн үед гэнэт нүүлгэн шилжих эсвэл гэртээ гацахад бэлэн байхын тулд яаралтай тусламжийн цүнхийг бэлтгэх нь чухал.</p>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                                    <i class="fas fa-suitcase mr-2"></i> Үндсэн зүйлс:
                                </h4>
                                <ul class="text-gray-700 space-y-2">
                                    <li class="emergency-kit-item">
                                        <i class="fas fa-tint text-blue-500"></i> Ус (3 хоногийн хэрэглээ)
                                    </li>
                                    <li class="emergency-kit-item">
                                        <i class="fas fa-utensils text-blue-500"></i> Хадгалалт сайтай хоол хүнс
                                    </li>
                                    <li class="emergency-kit-item">
                                        <i class="fas fa-first-aid text-blue-500"></i> Анхны тусламжийн хэрэгсэл
                                    </li>
                                    <li class="emergency-kit-item">
                                        <i class="fas fa-lightbulb text-blue-500"></i> Гэрэл, батерей
                                    </li>
                                </ul>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                                    <i class="fas fa-plus-circle mr-2"></i> Нэмэлт зүйлс:
                                </h4>
                                <ul class="text-gray-700 space-y-2">
                                    <li class="emergency-kit-item">
                                        <i class="fas fa-tshirt text-blue-500"></i> Хувцас, хөнжил
                                    </li>
                                    <li class="emergency-kit-item">
                                        <i class="fas fa-file-alt text-blue-500"></i> Бичиг баримтын хуулбар
                                    </li>
                                    <li class="emergency-kit-item">
                                        <i class="fas fa-baby text-blue-500"></i> Хүүхдийн тэжээл, тоглоом
                                    </li>
                                    <li class="emergency-kit-item">
                                        <i class="fas fa-paw text-blue-500"></i> Амьтны эм
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-tasks mr-2 text-blue-500"></i> Дасгал даалгавар
                            </h4>
                            <div id="assignment-questions-emergency-kit" class="space-y-3 mb-4">
                                <!-- Даалгаврын асуултууд энд ачаална -->
                            </div>
                            <!-- Assign a class to this section for easy targeting -->
                            <div class="assignment-upload-section border-t border-gray-200 pt-4 mt-4">
                                <h5 class="font-semibold text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-upload mr-2 text-blue-500"></i> Бие даалтын даалгавар хураалгах
                                </h4>
                                <p class="text-gray-700 text-sm mb-3">Өөрийн даалгаврын файлыг энд хавсаргана уу (PDF, Word, эсвэл зураг).</p>
                                <input type="file" id="assignment-file-emergency-kit" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none mb-3">
                                <button id="submit-assignment-emergency-kit" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center">
                                    <i class="fas fa-paper-plane mr-2"></i> Даалгавар хураах
                                </button>
                                <div id="submission-status-emergency-kit" class="mt-2 text-sm text-gray-700 hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Game Section (Одоо тоглоом шууд энд байна!) -->
        <section id="game-section" class="flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-blue-200 rounded-xl shadow-xl p-8 mb-16 border-2 border-blue-300">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-blue-800 mb-4">Мэдлэгээ шалгах тоглоом</h2>
                <div class="w-24 h-1 bg-blue-500 mx-auto mb-6"></div>
                <p class="text-gray-700 mb-6 max-w-3xl mx-auto">Гамшгийн аюулаас хамгаалах хичээлүүдээ үзэж дууссан бол, одоо мэдлэгээ сорих цаг боллоо! Доорх тоглоомыг ажиллуулж, асуултуудад хариулах замаар уулын оргил өөд авиран, мэдлэгээ бататгаарай.</p>
            </div>
            
            <!-- Тоглоомын үндсэн контейнер -->
            <div id="game-area-container" class="game-area-container bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl mx-auto border-4 border-blue-500 flex flex-col items-center">
                <h3 class="text-3xl md:text-4xl font-bold text-blue-700 mb-4 text-center">Уулын оргил өөд авирах тоглоом</h3>
                <p class="text-gray-700 mb-6 text-center">Гамшгийн аюулаас хамгаалах мэдлэгээ шалгаж, оргилд хүр!</p>

                <!-- Шинэчилсэн: Тоглоомын агуулга ба авирагчийн байрлал -->
                <div class="flex flex-col md:flex-row gap-6 w-full items-start">
                    <!-- Зүүн тал: Тоглоомын үндсэн UI -->
                    <div class="flex-grow">
                        <div id="player-info-form" class="mb-4 p-4 bg-gray-50 rounded-lg shadow-inner">
                            <label for="student-class" class="block text-gray-700 text-sm font-bold mb-2">Анги:</label>
                            <input type="text" id="student-class" placeholder="Жишээ нь: 5Б" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4">
                            
                            <label for="student-group" class="block text-gray-700 text-sm font-bold mb-2">Бүлэг (Нэр/Код):</label>
                            <input type="text" id="student-group" placeholder="Жишээ нь: Сармагчин баг / B2" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>

                        <div id="question-display" class="bg-blue-100 p-4 rounded-lg shadow-inner mb-4 hidden">
                            <p id="question-count-text" class="text-sm text-gray-600 mb-2 text-right"></p>
                            <p id="question-text" class="text-xl font-medium text-gray-900 mb-3 text-center"></p>
                            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <!-- Сонголтууд энд ачаална -->
                            </div>
                        </div>

                        <div id="feedback-display" class="p-3 mt-4 rounded-lg text-center font-medium hidden"></div>
                        <div id="save-status-display" class="p-3 mt-4 rounded-lg text-center font-medium hidden"></div>
                    </div>

                    <!-- Баруун тал: Босоо progress bar болон авирагч -->
                    <div class="w-full md:w-1/5 flex flex-col items-center justify-end relative h-[300px] bg-gradient-to-t from-gray-700 to-gray-500 rounded-lg shadow-inner overflow-hidden border border-gray-600 p-2">
                        <div id="vertical-altitude-track" class="w-8 bg-gray-200 rounded-full h-full relative overflow-hidden">
                            <div id="altitude-bar" class="bg-green-500 w-full rounded-full transition-all duration-500 absolute bottom-0 left-0" style="height: 0%;"></div>
                        </div>
                        <div id="climber-dot" class="absolute hidden" style="bottom: 0px; left: 50%; transform: translateX(-50%);"><i class="fas fa-person-hiking text-xl"></i></div>
                        <p class="text-sm font-semibold text-white mt-2">Одоогийн өндөр: <span id="current-altitude-vertical">0</span>м</p>
                        <p class="text-sm font-semibold text-white">Оргил: <span id="summit-altitude-vertical">100</span>м</p>
                    </div>
                </div>

                <button id="start-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 w-full mt-6">Тоглоом эхлүүлэх</button>
            </div>

            <!-- Loading Overlay -->
            <div id="loading-overlay" class="loading-overlay hidden rounded-xl">
                <div class="loading-spinner"></div>
                <p class="mt-4 text-gray-700">Ачаалж байна...</p>
            </div>
        </section>

        <!-- Game Results Section (Шинээр нэмэгдсэн) -->
        <section id="game-results-section" class="bg-gradient-to-r from-purple-100 to-purple-200 rounded-xl shadow-xl p-8 mb-16 border-2 border-purple-300">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-purple-800 mb-4">Тоглоомын Үр дүнгүүд</h2>
                <div class="w-24 h-1 bg-purple-500 mx-auto mb-6"></div>
                <p class="text-gray-700 max-w-3xl mx-auto">Энд та өөрийн болон бусад тоглогчдын тоглоомын үр дүнг харах боломжтой. Хамгийн өндөр оноог хэн авсныг шалгаарай!</p>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 max-w-4xl mx-auto">
                <div id="results-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                    <div class="bg-purple-50 p-4 rounded-lg shadow-sm">
                        <p class="text-sm text-gray-600">Нийт тоглосон тоо</p>
                        <p id="total-games-played" class="text-2xl font-bold text-purple-700">0</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg shadow-sm">
                        <p class="text-sm text-gray-600">Дундаж оноо</p>
                        <p id="average-score" class="text-2xl font-bold text-purple-700">0</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg shadow-sm">
                        <p class="text-sm text-gray-600">Хамгийн өндөр оноо</p>
                        <p id="highest-score" class="text-2xl font-bold text-purple-700">0</p>
                    </div>
                </div>

                <div id="results-table-container" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">
                                    Хэрэглэгч ID
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Анги
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Бүлэг
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Оноо
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Үр дүн
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">
                                    Огноо
                                </th>
                            </tr>
                        </thead>
                        <tbody id="game-results-body" class="bg-white divide-y divide-gray-200">
                            <!-- Үр дүнгүүд энд ачаална -->
                        </tbody>
                    </table>
                </div>
                <div id="game-results-loading-indicator" class="mt-4 text-center text-gray-600 flex items-center justify-center hidden">
                    <div class="loading-spinner mr-2"></div>
                    Үр дүнгүүдийг ачаалж байна...
                </div>
                <div id="game-results-error-message" class="mt-4 text-center text-red-600 hidden">
                    Үр дүнгүүдийг ачаалахад алдаа гарлаа. Дахин оролдоно уу.
                </div>
            </div>
        </section>


        <!-- Chatbot Section (Шинээр нэмэгдсэн) -->
        <section id="chatbot-section" class="bg-gradient-to-r from-green-100 to-green-200 rounded-xl shadow-xl p-8 mb-16 border-2 border-green-300">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-green-800 mb-4">Асуулт Хариултын Чатбот</h2>
                <div class="w-24 h-1 bg-green-500 mx-auto mb-6"></div>
                <p class="text-gray-700 max-w-3xl mx-auto">Гамшгийн аюулаас хамгаалахтай холбоотой ямар ч асуулт байвал манай чатботаас асуугаарай. Бид танд туслахад бэлэн байна!</p>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 max-w-2xl mx-auto flex flex-col h-96">
                <div id="chat-history" class="chat-container flex-grow mb-4">
                    <div class="bot-message chat-message">
                        Сайн байна уу! Гамшгийн аюулаас хамгаалах талаар юу мэдэхийг хүсэж байна вэ?
                    </div>
                </div>
                <div class="chatbot-input-area">
                    <input type="text" id="user-input" placeholder="Асуултаа энд бичнэ үү..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button id="send-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center">
                        <i class="fas fa-paper-plane mr-2"></i> Илгээх
                    </button>
                </div>
                <div id="chatbot-loading-indicator" class="mt-2 text-center text-gray-600 flex items-center justify-center hidden">
                    <div class="loading-spinner mr-2"></div>
                    Хариулж байна...
                </div>
            </div>
        </section>

        <!-- Resources Section -->
        <section id="resources" class="bg-white rounded-xl shadow-xl p-8 mb-16">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Нэмэлт Мэдээлэл ба Холбоосууд</h2>
                <div class="w-24 h-1 bg-blue-500 mx-auto mb-6"></div>
            </div>
            <ul class="list-disc list-inside text-gray-700 space-y-4">
                <li><a href="https://nema.gov.mn/" target="_blank" class="text-blue-600 hover:underline flex items-center"><i class="fas fa-globe mr-2"></i> Онцгой байдлын ерөнхий газар (ОБЕГ) - Албан ёсны мэдээлэл, зөвлөмж.</a></li>
                <!-- Шинэчилсэн Яаралтай тусламжийн утасны жагсаалт -->
                <li><span class="text-blue-600 flex items-center"><i class="fas fa-phone mr-2"></i> Яаралтай тусламжийн дугаарууд:</span>
                    <ul class="list-disc list-inside ml-6 mt-2 space-y-1">
                        <li>Цагдаа: <a href="tel:102" class="text-blue-600 hover:underline">102</a></li>
                        <li>Гал түймэр: <a href="tel:101" class="text-blue-600 hover:underline">101</a></li>
                        <li>Түргэн тусламж: <a href="tel:103" class="text-blue-600 hover:underline">103</a></li>
                        <li>Гамшгаас хамгаалах ерөнхий дугаар (ОБЕГ): <a href="tel:105" class="text-blue-600 hover:underline">105</a></li>
                        <li>Эрчим хүчний гэмтэл: <a href="tel:104" class="text-blue-600 hover:underline">104</a></li>
                        <li>Хүүхэд хамгаалах тусламж: <a href="tel:108" class="text-blue-600 hover:underline">108</a></li>
                        <!-- Та энд өөр дугаарууд нэмэх боломжтой -->
                    </ul>
                </li>
                <li><a href="https://cdn.greensoft.mn/uploads/users/5112/files/Disaster%20reduction_Layout%20Sketch%20Up_20230922.pdf" target="_blank" class="text-blue-600 hover:underline flex items-center"><i class="fas fa-file-pdf mr-2"></i> Гамшгаас хамгаалах гарын авлага (PDF) - (Та өөрийн гарын авлагаа холбоно уу)</a></li>
                <li><a href="#" class="text-blue-600 hover:underline flex items-center"><i class="fas fa-video mr-2"></i> Видео хичээлүүд (Youtube Playlist) - (Хийсвэр холбоос)</a></li>
            </ul>
        </section>

        <!-- About Section -->
        <section id="about" class="bg-white rounded-xl shadow-xl p-8 mb-8">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Бидний тухай</h2>
                <div class="w-24 h-1 bg-blue-500 mx-auto mb-6"></div>
            </div>
            <p class="text-gray-700 leading-relaxed text-center max-w-3xl mx-auto" id="about-text">
                Энэхүү сайтыг бид хэн ч хаанаас ч хандан гамшгийн эрсдлийн үед өөрийгөө хамгаалах чадварт суралцахад зориулан бүтээлээ.Та бүхэн тухлан сонирхоод мэдлэгээ хөгжүүлээрэй.
            </p>
            <div class="flex justify-center mt-6">
                <button id="play-about-text" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center">
                    <i class="fas fa-volume-up mr-2"></i> Танилцуулгыг сонсох
                </button>
                <div id="tts-loading-indicator" class="ml-4 flex items-center justify-center hidden">
                    <div class="loading-spinner mr-2"></div>
                    Дуу үүсгэж байна...
                </div>
            </div>
            <div class="flex justify-center mt-4">
                <a href="mailto:info@example.com" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center">
                    <i class="fas fa-envelope mr-2"></i> Холбоо барих
                </a>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white p-6 text-center mt-auto rounded-t-xl shadow-inner">
        <p>&copy; 2025 Гамшгийн Аюулаас Хамгаалах Мэдлэг. Бүх эрх хуулиар хамгаалагдсан.</p>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";


        // Global variables provided by Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let storage;
        let currentUserId = null;

        // New function to handle section visibility
        function showSection(sectionId) {
            const allSections = document.querySelectorAll('main > section');

            allSections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.remove('hidden');
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    if (sectionId === 'game-results-section') {
                        loadGameResults();
                    }
                } else {
                    section.classList.add('hidden');
                }
            });
        }


        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Firebase
            if (Object.keys(firebaseConfig).length > 0) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                // Sign in anonymously or with custom token
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("Firebase authenticated. User ID:", currentUserId);
                    } else {
                        console.log("Firebase authentication state changed: No user.");
                        signInAnonymously(auth).then((userCredential) => {
                            currentUserId = userCredential.user.uid;
                            console.log("Signed in anonymously. User ID:", currentUserId);
                        }).catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                        });
                    }
                });

                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } catch (error) {
                        console.error("Custom token sign-in failed:", error);
                        signInAnonymously(auth).then((userCredential) => {
                            currentUserId = userCredential.user.uid;
                            console.log("Signed in anonymously as fallback. User ID:", currentUserId);
                        }).catch((errorAnon) => {
                            console.error("Fallback anonymous sign-in failed:", errorAnon);
                        });
                    }
                } else {
                    signInAnonymously(auth).then((userCredential) => {
                        currentUserId = userCredential.user.uid;
                        console.log("Signed in anonymously. User ID:", currentUserId);
                    });
                }
            } else {
                console.warn("Firebase config not found. Firestore data saving will not work.");
            }

            showSection('lessons');

            document.querySelectorAll('header nav.md\\:flex a').forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    showSection(targetId);
                });
            });

            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');

            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });

            const mobileMenuItems = mobileMenu.querySelectorAll('a');
            mobileMenuItems.forEach(item => {
                item.addEventListener('click', (event) => {
                    event.preventDefault();
                    mobileMenu.classList.add('hidden');
                    const targetId = item.getAttribute('href').substring(1);
                    showSection(targetId);
                });
            });

            document.querySelectorAll('[id^="submit-assignment-"]').forEach(button => {
                button.addEventListener('click', (event) => {
                    const lessonId = event.target.id.replace('submit-assignment-', '');
                    handleAssignmentSubmission(lessonId);
                });
            });
            questionDisplay.classList.add('hidden');
            hideGameLoading();
        });

        // --- Video Lesson Management Script ---
        const videoLessons = {
            'earthquake-lesson': {
                'Бага анги': 'https://www.youtube.com/embed/EFgomRAPDyM?si=9mFv-Et6WhmsfZKk',
                'Дунд анги': 'https://www.youtube.com/embed/PrVOj-1goqs',
                'Ахлах анги': 'https://www.youtube.com/embed/l4F0VTUcbbE'
            },
            'flood-lesson': {
                'Бага анги': 'https://www.youtube.com/embed/trGVxwT9n3k',
                'Дунд анги': 'https://www.youtube.com/embed/CCpQdz3g_gs',
                'Ахлах анги': 'https://www.youtube.com/embed/oZk37uORL1o'
            },
            'fire-lesson': {
                'Бага анги': 'https://www.youtube.com/embed/eV8VTi_7Ha0',
                'Дунд анги': 'https://www.youtube.com/embed/UeRIm6nnAgg',
                'Ахлах анги': 'https://www.youtube.com/embed/WjNKweQLF-E'
            },
            'blizzard-lesson': {
                'Бага анги': 'https://www.youtube.com/embed/xj2SPYpg6o4',
                'Дунд анги': 'https://www.youtube.com/embed/Qz7MU9qHKSE',
                'Ахлах анги': 'https://www.youtube.com/embed/Qz7MU9qHKSE'
            },
            'emergency-kit-lesson': {
                'Бага анги': 'https://www.youtube.com/embed/pc7xSYAShPs?si=VAWM1xM-CIDL2y8z',
                'Дунд анги': 'https://www.youtube.com/embed/pc7xSYAShPs?si=VAWM1xM-CIDL2y8z',
                'Ахлах анги': 'https://www.youtube.com/embed/pc7xSYAShPs'
            }
        };

        const lessonAssignmentQuestions = {
            'earthquake-lesson': {
                'Бага анги': [
                    "Газар хөдлөлтийн үед яагаад ширээн доор орох ёстой вэ?",
                    "Танай гэр бүл газар хөдлөлтөөс хэрхэн хамгаалах төлөвлөгөөтэй вэ?"
                ],
                'Дунд анги': [
                    "Газар хөдлөлтийн үед барилгын ямар хэсгүүд хамгийн аюулгүй байдаг вэ?",
                    "Газар хөдлөлтийн дараах анхны тусламжийн талаар юу мэдэх вэ?"
                ],
                'Ахлах анги': [
                    "Газар хөдлөлтийн үед барилга байгууламжийн аюулгүй байдлыг хангахын тулд ямар инженерийн шийдлүүд ашигладаг вэ?",
                    "Газар хөдлөлтийн улмаас үүсэх сэтгэл зүйн нөлөөлөл болон түүнийг хэрхэн даван тулах талаар тайлбарлана уу?"
                ]
            },
            'flood-lesson': {
                'Бага анги': [
                    "Үер усны аюулаас хэрхэн хол байх вэ?",
                    "Үерийн үед юу авч явах ёстой вэ?"
                ],
                'Дунд анги': [
                    "Үерийн үед цахилгааны аюулгүй байдлыг хэрхэн хангах вэ?",
                    "Үерийн дараа ямар өвчлөлүүд тархах магадлалтай байдаг вэ?"
                ],
                'Ахлах анги': [
                    "Уур амьсгалын өөрчлөлт үерийн давтамж, эрчимшилд хэрхэн нөлөөлж байна вэ?",
                    "Хотын төлөвлөлт үерийн эрсдэлийг бууруулахад хэрхэн нөлөөлдөг вэ?"
                ]
            },
            'fire-lesson': {
                'Бага анги': [
                    "Гал гарах үед ямар дугаарт залгах вэ?",
                    "Галд түлэгдэхээс хэрхэн сэргийлэх вэ?"
                ],
                'Дунд анги': [
                    "Гал сөнөөгч хүмүүсийг аврахдаа ямар багаж хэрэгсэл ашигладаг вэ?",
                    "Хуурай өвс, ой хөвчид гал гарахгүй байхын тулд ямар арга хэмжээ авах хэрэгтэй вэ?"
                ],
                'Ахлах анги': [
                    "Гал түймрийн үед утааны дохиолол ямар ач холбогдолтой вэ, мөн үүнийг хэрхэн зөв байрлуулах вэ?",
                    "Галын аюулгүй байдлын үнэлгээг хэрхэн хийдэг вэ, мөн байгууллагууд үүнийг яагаад хийх ёстой вэ?"
                ]
            },
            'blizzard-lesson': {
                'Бага анги': [
                    "Цасан шуурганы үед яагаад гадаа тоглохгүй байх ёстой вэ?",
                    "Хүйтний улиралд дулаан байхын тулд юу өмсөх ёстой вэ?"
                ],
                'Дунд анги': [
                    "Цасан шуурганы үед цахилгаан тасарвал юу хийх вэ?",
                    "Даарахаас хэрхэн сэргийлэх вэ?"
                ],
                'Ахлах анги': [
                    "Цасан шуурганы үед тээврийн хэрэгслийн аюулгүй байдлыг хэрхэн хангах вэ?",
                    "Малчин айлууд цасан шуурганд хэрхэн бэлддэг вэ, мөн тэдэнд ямар тусламж үзүүлэх боломжтой вэ?"
                ]
            },
            'emergency-kit-lesson': {
                'Бага анги': [
                    "Яаралтай тусламжийн цүнхэнд та ямар хоёр зүйл хийх вэ?",
                    "Яагаад ус хамгийн чухал вэ?"
                ],
                'Дунд анги': [
                    "Яаралтай тусламжийн цүнхэнд ямар төрлийн эм, эмийн хэрэгсэл байх ёстой вэ?",
                    "Цүнхэндээ чухал бичиг баримтын хуулбарыг яагаад хийх ёстой вэ?"
                ],
                'Ахлах анги': [
                    "Яаралтай тусламжийн цүнхний агууламжийг танай гэр бүлийн онцлогт хэрхэн тохируулах вэ?",
                    "Гамшгийн дараах сэргээн босгоход яаралтай тусламжийн цүнх хэрхэн хувь нэмэр оруулах вэ?"
                ]
            }
        };

        let currentActiveGrade = 'Ахлах анги';

        function updateLessonContent(grade) {
            currentActiveGrade = grade;

            document.querySelectorAll('[data-grade]').forEach(button => {
                if (button.dataset.grade === grade) {
                    button.classList.remove('bg-white', 'hover:bg-gray-100');
                    button.classList.add('bg-blue-100', 'hover:bg-blue-200');
                } else {
                    button.classList.remove('bg-blue-100', 'hover:bg-blue-200');
                    button.classList.add('bg-white', 'hover:bg-gray-100');
                }
            });

            document.querySelectorAll('.lesson-card').forEach(lessonCard => {
                const lessonId = lessonCard.id;
                
                const videoContainer = lessonCard.querySelector('.video-responsive');
                const iframe = videoContainer ? videoContainer.querySelector('iframe') : null;
                if (iframe && videoLessons[lessonId] && videoLessons[lessonId][grade]) {
                    iframe.src = videoLessons[lessonId][grade];
                }

                const assignmentQuestionsDiv = lessonCard.querySelector(`[id^="assignment-questions-"]`);
                if (assignmentQuestionsDiv && lessonAssignmentQuestions[lessonId] && lessonAssignmentQuestions[lessonId][grade]) {
                    assignmentQuestionsDiv.innerHTML = '';
                    lessonAssignmentQuestions[lessonId][grade].forEach(questionText => {
                        const questionWrapper = document.createElement('div');
                        questionWrapper.classList.add('flex', 'items-start');
                        
                        const iconDiv = document.createElement('div');
                        iconDiv.classList.add('flex-shrink-0', 'mt-1');
                        iconDiv.innerHTML = '<i class="fas fa-question-circle text-blue-500"></i>';
                        
                        const textDiv = document.createElement('div');
                        textDiv.classList.add('ml-3');
                        const pTag = document.createElement('p');
                        pTag.classList.add('text-gray-700');
                        pTag.textContent = questionText;
                        
                        textDiv.appendChild(pTag);
                        questionWrapper.appendChild(iconDiv);
                        questionWrapper.appendChild(textDiv);
                        assignmentQuestionsDiv.appendChild(questionWrapper);
                    });
                }

                const uploadSection = lessonCard.querySelector('.assignment-upload-section');
                if (uploadSection) {
                    if (grade === 'Бага анги') {
                        uploadSection.classList.add('hidden');
                    } else {
                        uploadSection.classList.remove('hidden');
                    }
                }
            });
        }

        document.getElementById('grade-btn-baga').addEventListener('click', () => updateLessonContent('Бага анги'));
        document.getElementById('grade-btn-dund').addEventListener('click', () => updateLessonContent('Дунд анги'));
        document.getElementById('grade-btn-ahlah').addEventListener('click', () => updateLessonContent('Ахлах анги'));

        document.addEventListener('DOMContentLoaded', () => {
            updateLessonContent(currentActiveGrade);
        });


        // --- Mountain Climb Game JavaScript Script ---
        const allGameQuestions = [
            {
                "question": "Газар хөдлөлтийн үед юу хийх ёстой вэ?",
                "options": {
                    "А": "Гэрийнхээ гадаа гүйж гарах",
                    "Б": "Ширээ эсвэл бат бөх тавилганы доор орох",
                    "В": "Цонхны дэргэд зогсох",
                    "Г": "Цахилгаан шатаар доошоо буух"
                },
                "answer": "Б",
                "explanation": "Газар хөдлөлтийн үед ширээ эсвэл бат бөх тавилганы доор орж, толгой, хүзүүгээ хамгаалах нь хамгийн аюулгүй юм."
            },
            {
                "question": "Гэнэтийн үерээс хэрхэн хамгаалах вэ?",
                "options": {
                    "А": "Үерийн усанд орох",
                    "Б": "Өндөрлөг газар руу нүүлгэн шилжих",
                    "В": "Машинаар зугтах",
                    "Г": "Гэртээ үлдэж үерийг хүлээх"
                },
                "answer": "Б",
                "explanation": "Үерлэж эхлэх үед хамгийн түрүүнд хийх зүйл бол өндөрлөг, аюулгүй газар руу нүүлгэн шилжих явдал юм."
            },
            {
                "question": "Гал түймэр гарах үед хамгийн эхний хийх алхам юу вэ?",
                "options": {
                    "А": "Утсаар видео хийх",
                    "Б": "Гал сөнөөгч дуудах",
                    "В": "Галын хорыг олох",
                    "Г": "Өөрийгөө хамгаалаад гарах гарцаа олох"
                },
                "answer": "Г",
                "explanation": "Гал түймэр гарах үед хамгийн чухал нь амиа аврах юм. Өөрийгөө хамгаалаад хамгийн ойрын гарцаар гарч, аюулгүй газар очих хэрэгтэй."
            },
            {
                "question": "Цасан шуурганы үед автомашиндаа гацвал юу хийх ёстой вэ?",
                "options": {
                    "А": "Гадаа гарч тусламж эрж хайх",
                    "Б": "Машины хөдөлгүүрийг байнга асаалттай байлгах",
                    "В": "Машиндаа үлдэж, тусламж хүлээн, дулаан байлгах",
                    "Г": "Зугтахыг оролдох"
                },
                "answer": "В",
                "explanation": "Цасан шуурганд гацсан үед машинаа орхиж явах нь аюултай. Машиндаа үлдэж, дулаан байлгахыг хичээж, тусламж дуудах эсвэл хүлээх хэрэгтэй."
            },
            {
                "question": "Гамшгийн үед яаралтай тусламжийн цүнхэнд юу зайлшгүй байх ёстой вэ?",
                "options": {
                    "А": "Чихэр, ундаа",
                    "Б": "Ус, эм тариа, анхны тусламжийн хэрэгсэл",
                    "В": "Сошиал медиа хийх утас",
                    "Г": "Тоглоом, ном"
                },
                "answer": "Б",
                "explanation": "Гамшгийн үед ус, эм тариа, анхны тусламжийн хэрэгсэл зэрэг амьдралд зайлшгүй шаардлагатай зүйлсийг бэлэн байлгах нь чухал."
            },
             {
                "question": "Хүчтэй салхи шуурганы үед гэртээ байвал ямар арга хэмжээ авах вэ?",
                "options": {
                    "А": "Цонхны ойролцоо зогсож гаднаа юу болж байгааг харах",
                    "Б": "Цонх, хаалгыг бэхлэх, аюулгүй өрөөнд орох",
                    "В": "Машинаар гадагш гарахыг оролдох",
                    "Г": "Цахилгаан хэрэгслээ ажиллуулж байх"
                },
                "answer": "Б",
                "explanation": "Хүчтэй салхи шуурганы үед цонх, хаалгыг бэхэлж, аюулгүй, цонхгүй өрөөнд байрлах нь зүйтэй."
            },
            {
                "question": "Үер буухад цахилгааны аюулгүй байдлыг хэрхэн хангах вэ?",
                "options": {
                    "А": "Цахилгааныг салгахгүй байх",
                    "Б": "Үерийн усанд цахилгаантай холбоотой юманд хүрэх",
                    "В": "Цахилгааныг үндсэн хэлхээнээс салгах",
                    "Г": "Утасгүй цэнэглэгч ашиглах"
                },
                "answer": "В",
                "explanation": "Үерлэж байх үед цахилгаанд цохиулах эрсдэлээс сэргийлэхийн тулд цахилгааныг үндсэн хэлхээнээс салгах нь чухал."
            },
            {
                "question": "Гал түймрээс урьдчилан сэргийлэх хамгийн энгийн арга юу вэ?",
                "options": {
                    "А": "Утааны дохиолол тавихгүй байх",
                    "Б": "Ил гал үүсгэх",
                    "В": "Утааны дохиолол тавьж, байнга шалгах",
                    "Г": "Шатамхай зүйлийг галын ойролцоо байлгах"
                },
                "answer": "В",
                "explanation": "Утааны дохиолол нь галын эрсдэлийг эрт илрүүлж, хүний амь насыг аврахад чухал үүрэгтэй."
            },
            {
                "question": "Цасан шуурганы үед ямар хувцас өмсөх нь хамгийн тохиромжтой вэ?",
                "options": {
                    "А": "Нимгэн, хөвөн хувцас",
                    "Б": "Давхарлаж өмсөх дулаан, ус нэвтрүүлдэггүй хувцас",
                    "В": "Богино ханцуйтай цамц, шорт",
                    "Г": "Зөвхөн нэг зузаан хүрэм"
                },
                "answer": "Б",
                "explanation": "Давхарлаж өмсөх нь биеийн дулааныг илүү сайн хадгалдаг бөгөөд ус нэвтрүүлдэггүй хувцас нь цас, хүйтнээс хамгаална."
            },
            {
                "question": "Яаралтай тусламжийн цүнхэнд ямар бичиг баримтын хуулбарыг хийх ёстой вэ?",
                "options": {
                    "А": "Киноны тасалбар",
                    "Б": "Иргэний үнэмлэх, төрсний гэрчилгээ, банкны дансны мэдээлэл зэрэг чухал бичиг баримтуудын хуулбар",
                    "В": "Хуучин сонин",
                    "Г": "Хоосон цаас"
                },
                "answer": "Б",
                "explanation": "Гамшгийн үед чухал бичиг баримтууд алга болсон тохиолдолд тэдгээрийн хуулбар нь иргэний үнэмлэхээ баталгаажуулах, санхүүгийн асуудлыг шийдвэрлэхэд чухал үүрэгтэй."
            },
            {
                "question": "Газар хөдлөлтийн үед цахилгаан шат ашиглах нь яагаад аюултай вэ?",
                "options": {
                    "А": "Цахилгаан шатны хөдөлгөөн хурдасдаг",
                    "Б": "Цахилгаан тасарч, шатанд гацах магадлалтай",
                    "В": "Бусад хүмүүстэй хамт байх таагүй",
                    "Г": "Цахилгаан шат унах магадлалтай"
                },
                "answer": "Б",
                "explanation": "Газар хөдлөлтийн үед цахилгаан тасарч, цахилгаан шат гацаж, дотор нь гацах аюултай."
            },
            {
                "question": "Үерийн дараа эрүүл мэндээ хамгаалахын тулд юу хийх вэ?",
                "options": {
                    "А": "Бохирдсон усыг уух",
                    "Б": "Үерийн усанд дүрсэн хоол хүнс хэрэглэх",
                    "В": "Гараа тогтмол угааж, аюулгүй усыг хэрэглэх",
                    "Г": "Эмнэлэгт очихгүй байх"
                },
                "answer": "В",
                "explanation": "Үерийн дараа ус бохирдож, өвчин үүсгэгч нян тархах эрсдэл өндөр байдаг тул хувийн ариун цэврийг сахиж, аюулгүй ус хэрэглэх нь чухал."
            },
            {
                "question": "Гал түймрийн үед утаанаас хэрхэн хамгаалах вэ?",
                "options": {
                    "А": "Босоо зогсох",
                    "Б": "Газраар мөлхөх",
                    "В": "Гүнзгий амьсгалах",
                    "Г": "Цонх онгойлгох"
                },
                "answer": "Б",
                "explanation": "Гал түймрийн үед утаа дээшээ өгсдөг тул газарт ойр мөлхөх нь агаар амьсгалах боломжийг нэмэгдүүлнэ."
            },
            {
                "question": "Гамшгийн үед гэр бүлийн цугларах цэг яагаад чухал вэ?",
                "options": {
                    "А": "Зөвхөн зугаацах зорилгоор",
                    "Б": "Гэр бүлийн гишүүд аюулгүйгээр цугларах газар",
                    "В": "Хоол идэх газар",
                    "Г": "Видео тоглоом тоглох газар"
                },
                "answer": "Б",
                "explanation": "Гамшгийн үед гэр бүлийн гишүүд бие биенээ олох, аюулгүйгээр цугларах зорилгоор урьдчилан тогтсон цугларах цэгтэй байх нь чухал."
            },
            {
                "question": "Яаралтай тусламжийн 103 дугаар аль үйлчилгээнийх вэ?",
                "options": {
                    "А": "Цагдаа",
                    "Б": "Гал түймэр",
                    "В": "Түргэн тусламж",
                    "Г": "Онцгой байдал"
                },
                "answer": "В",
                "explanation": "103 нь түргэн тусламжийн дугаар юм."
            },
            {
                "question": "Хүйтэн жавар ихтэй үед биеийн аль хэсгүүд хамгийн түрүүнд хөлддөг вэ?",
                "options": {
                    "А": "Хөл, гар",
                    "Б": "Хүзүү, цээж",
                    "В": "Чих, хамар, хуруу, хөлний хуруу",
                    "Г": "Нуруу, мөр"
                },
                "answer": "В",
                "explanation": "Хүйтэн жаварт хамгийн их өртдөг, хөлддөг хэсгүүд бол чих, хамар, хуруу, хөлний хуруу зэрэг захын хэсгүүд юм."
            },
            {
                "question": "Гамшгийн үед мэдээлэл авахад хамгийн найдвартай эх сурвалж юу вэ?",
                "options": {
                    "А": "Сошиал медиагийн цуу яриа",
                    "Б": "Найзуудын яриа",
                    "В": "Албан ёсны мэдээллийн сувгууд (радио, телевиз, Онцгой байдлын байгууллага)",
                    "Г": "Интернет дэх санамсаргүй мэдээлэл"
                },
                "answer": "В",
                "explanation": "Гамшгийн үед албан ёсны эх сурвалжуудаас мэдээлэл авах нь хамгийн найдвартай бөгөөд зөв шийдвэр гаргахад тустай."
            },
            {
                "question": "Усны нөөцгүй үед үерээс хэрхэн аюулгүй ус авах вэ?",
                "options": {
                    "А": "Бохирдсон усыг шууд уух",
                    "Б": "Усыг буцалгаж, цэвэрлэсний дараа уух",
                    "В": "Үерийн усаар шүдээ угаах",
                    "Г": "Ямар ч ус уухгүй байх"
                },
                "answer": "Б",
                "explanation": "Үерийн дараа ус бохирдох эрсдэлтэй байдаг тул заавал буцалгаж эсвэл цэвэрлэгээний арга хэмжээ авсны дараа хэрэглэх ёстой."
            },
            {
                "question": "Гал түймрийн аюулаас урьдчилан сэргийлэхэд цахилгааны аюулгүй байдал яагаад чухал вэ?",
                "options": {
                    "А": "Цахилгаан бага зарцуулахын тулд",
                    "Б": "Цахилгааны гэмтлээс үүдэлтэй гал түймрийг багасгахын тулд",
                    "В": "Утасгүй интернэттэй байхын тулд",
                    "Г": "Гэрлээ тод байлгахын тулд"
                },
                "answer": "Б",
                "explanation": "Цахилгааны гэмтэл, хэт ачаалал нь гал түймэр гарах нийтлэг шалтгаануудын нэг тул цахилгааны аюулгүй байдлыг хангах нь чухал."
            },
            {
                "question": "Гамшгийн үед гэртээ гацсан үед хоол хүнсний нөөц яагаад хэрэгтэй вэ?",
                "options": {
                    "А": "Зөвхөн амттай хоол идэхийн тулд",
                    "Б": "Дэлгүүр хаагдсан үед өлсгөлөнгөөс сэргийлэхийн тулд",
                    "В": "Зөвхөн найз нөхдөө дайлахын тулд",
                    "Г": "Биеийн жингээ нэмэхийн тулд"
                },
                "answer": "Б",
                "explanation": "Гамшгийн үед дэлгүүр, зах хаагдах, тээврийн хэрэгсэл хөдлөхгүй болох зэрэг хүндрэлүүд үүсдэг тул хоол хүнсний нөөцтэй байх нь зайлшгүй шаардлагатай."
            },
            {
                "question": "Хүүхдүүд гамшгийн үед айдастай байвал хэрхэн туслах вэ?",
                "options": {
                    "А": "Тэднийг үл тоомсорлох",
                    "Б": "Тэдэнтэй ярилцаж, тайвшруулах, аюулгүй байдлыг нь мэдрүүлэх",
                    "В": "Тэднийг ганцааранг нь орхих",
                    "Г": "Тэдэнд видео тоглоом өгөх"
                },
                "answer": "Б",
                "explanation": "Гамшгийн үед хүүхдүүд айж, түгших нь элбэг байдаг тул тэдэнтэй ярилцаж, сэтгэл санааны дэмжлэг үзүүлэх нь маш чухал."
            },
            {
                "question": "Гамшгийн үед холбоо барих төлөвлөгөө яагаад хэрэгтэй вэ?",
                "options": {
                    "А": "Зөвхөн хөгжилдөх зорилгоор",
                    "Б": "Гэр бүлийн гишүүд хоорондоо холбоо тогтооход хялбар болгохын тулд",
                    "В": "Хөршүүдтэйгээ ярихын тулд",
                    "Г": "Утасны батерейгаа шалгахын тулд"
                },
                "answer": "Б",
                "explanation": "Гамшгийн үед холбоо тасрах, үүрэн холбоо ажиллахгүй болох тохиолдол гардаг тул гэр бүлийн гишүүд хэрхэн холбоо барих талаар урьдчилан төлөвлөгөөтэй байх нь чухал."
            },
            {
                "question": "Гамшгийн цүнхээ хэр их хугацаанд нэг удаа шалгах ёстой вэ?",
                "options": {
                    "А": "1 жил тутамд",
                    "Б": "5 жил тутамд",
                    "В": "10 жил тутамд",
                    "Г": "Хэзээ ч шалгахгүй байх"
                },
                "answer": "А",
                "explanation": "Яаралтай тусламжийн цүнхний агуулгыг жил бүр шалгаж, хугацаа нь дууссан хүнс, эм тариаг шинэчлэх нь зүйтэй."
            },
            {
                "question": "Гэр орондоо гал унтраагчтай байхын ач холбогдол юу вэ?",
                "options": {
                    "А": "Зөвхөн гоёл чимэглэл",
                    "Б": "Гал гарах үед түргэн шуурхай унтраах боломжийг олгоно",
                    "В": "Хаалга нээхэд туслана",
                    "Г": "Гэрэл асаахад хэрэглэнэ"
                },
                "answer": "Б",
                "explanation": "Жижиг хэмжээний гал түймрийг эхэн үед нь унтраахын тулд гал унтраагч байх нь маш чухал."
            },
            {
                "question": "Цасан шуурганы үед хүн яагаад гадаа удаан байх ёсгүй вэ?",
                "options": {
                    "А": "Хөгжилтэй биш",
                    "Б": "Хөлдөх эрсдэлтэй",
                    "В": "Цас идэхээс сэргийлэхийн тулд",
                    "Г": "Зөвхөн гэртээ л дасгал хийх ёстой"
                },
                "answer": "Б",
                "explanation": "Цасан шуурга, хүйтэн жавар нь хүнийг хөлдөөх аюултай тул гадаа удаан байхгүй байх нь чухал."
            }
        ];

        // Тоглоомын тохиргоо
        const SUMMIT_ALTITUDE = 100;
        const ALTITUDE_GAIN_PER_CORRECT_ANSWER = 10;
        const ALTITUDE_PENALTY_PER_INCORRECT_ANSWER = 5;
        const QUESTIONS_TO_ASK = 10;

        let currentAltitude = 0;
        let questionsAnsweredCount = 0;
        let gameQuestions = [];
        let gameClass = '';
        let gameGroup = '';

        // DOM элементүүд (Тоглоомын хэсэг доторх элементүүд)
        // Шинэчилсэн ID-ууд
        const currentAltitudeSpanVertical = document.getElementById('current-altitude-vertical');
        const summitAltitudeSpanVertical = document.getElementById('summit-altitude-vertical');
        const altitudeBar = document.getElementById('altitude-bar'); // Now represents the vertical bar
        const verticalAltitudeTrack = document.getElementById('vertical-altitude-track'); // New element
        const questionDisplay = document.getElementById('question-display');
        const questionCountText = document.getElementById('question-count-text');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackDisplay = document.getElementById('feedback-display');
        const startButton = document.getElementById('start-button');
        const gameLoadingOverlay = document.getElementById('loading-overlay');
        const playerInfoForm = document.getElementById('player-info-form');
        const studentClassInput = document.getElementById('student-class');
        const studentGroupInput = document.getElementById('student-group');
        const saveStatusDisplay = document.getElementById('save-status-display');
        
        const climberDot = document.getElementById('climber-dot');
        const gameAreaContainerElement = document.getElementById('game-area-container');


        // Эхний тохиргоо
        summitAltitudeSpanVertical.textContent = SUMMIT_ALTITUDE;
        
        // --- Game Logic Functions ---

        async function startGame() {
            gameClass = studentClassInput.value.trim();
            gameGroup = studentGroupInput.value.trim();

            if (!gameClass || !gameGroup) {
                saveStatusDisplay.classList.remove('hidden', 'bg-green-100', 'text-green-800');
                saveStatusDisplay.classList.add('bg-red-100', 'text-red-800');
                saveStatusDisplay.textContent = "Тоглоом эхлүүлэхийн тулд **анги** болон **бүлгийн мэдээллээ** оруулна уу!";
                return;
            }
            
            saveStatusDisplay.classList.add('hidden');

            showGameLoading();
            startButton.classList.add('hidden');
            playerInfoForm.classList.add('hidden');
            questionDisplay.classList.remove('hidden');
            
            climberDot.classList.remove('hidden');
            climberDot.style.bottom = '0px'; // Initial position for the climber

            currentAltitude = 0;
            questionsAnsweredCount = 0;
            
            const shuffledQuestions = [...allGameQuestions].sort(() => 0.5 - Math.random());
            gameQuestions = shuffledQuestions.slice(0, QUESTIONS_TO_ASK);

            updateDisplay();
            setTimeout(() => {
                hideGameLoading();
                displayQuestion();
            }, 500);
        }

        async function endGame() {
            clearGameDisplay();
            let message = "";
            let messageClass = "";
            let isWin = false;

            if (currentAltitude >= SUMMIT_ALTITUDE) {
                message = "Баяр хүргэе! Та уулын оргилд амжилттай гарч чадлаа!";
                messageClass = "bg-green-200 text-green-900";
                isWin = true;
            } else {
                message = `Уучлаарай, дахин судлана уу. Та ${currentAltitude}м өндөрт хүрсэн байна.`;
                messageClass = "bg-red-200 text-red-900";
                isWin = false;
            }
            
            questionText.textContent = message;
            questionText.classList.add(...messageClass.split(' '));
            questionText.classList.remove('mb-3');

            optionsContainer.innerHTML = '';
            feedbackDisplay.classList.add('hidden');

            startButton.textContent = "Дахин тоглох";
            startButton.classList.remove('hidden');
            playerInfoForm.classList.remove('hidden');

            climberDot.classList.add('hidden');

            hideGameLoading();

            await saveGameResult(isWin, currentAltitude, gameClass, gameGroup);
        }

        function showGameLoading() {
            gameLoadingOverlay.classList.remove('hidden');
        }

        function hideGameLoading() {
            gameLoadingOverlay.classList.add('hidden');
        }

        function updateDisplay() {
            // Update vertical altitude display
            currentAltitudeSpanVertical.textContent = currentAltitude;
            
            const progress = (currentAltitude / SUMMIT_ALTITUDE) * 100;
            
            // Update vertical altitude bar height
            altitudeBar.style.height = `${progress}%`;
            
            if (currentAltitude >= SUMMIT_ALTITUDE * 0.7) {
                altitudeBar.classList.remove('bg-yellow-500', 'bg-red-500');
                altitudeBar.classList.add('bg-green-500');
            } else if (currentAltitude >= SUMMIT_ALTITUDE * 0.3) {
                altitudeBar.classList.remove('bg-green-500', 'bg-red-500');
                altitudeBar.classList.add('bg-yellow-500');
            } else {
                altitudeBar.classList.remove('bg-green-500', 'bg-yellow-500');
                altitudeBar.classList.add('bg-red-500');
            }

            // Update climber dot position relative to the vertical track
            const trackHeight = verticalAltitudeTrack.clientHeight;
            const climberHeight = climberDot.clientHeight;
            // Calculate bottom position: 0% at bottom, 100% at top (adjusted for climber's height)
            const newBottomPx = (currentAltitude / SUMMIT_ALTITUDE) * (trackHeight - climberHeight);
            climberDot.style.bottom = `${newBottomPx}px`;
        }

        function displayQuestion() {
            if (questionsAnsweredCount >= QUESTIONS_TO_ASK) {
                endGame();
                return;
            }

            const currentQuestion = gameQuestions[questionsAnsweredCount];
            
            questionCountText.textContent = `Асуулт: ${questionsAnsweredCount + 1} / ${QUESTIONS_TO_ASK}`;
            questionText.textContent = currentQuestion.question;
            optionsContainer.innerHTML = '';

            for (const key in currentQuestion.options) {
                const button = document.createElement('button');
                button.textContent = `${key}. ${currentQuestion.options[key]}`;
                button.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'font-medium', 'py-2', 'px-4', 'rounded-lg', 'transition', 'duration-200', 'text-left');
                button.addEventListener('click', () => checkAnswer(key, currentQuestion.answer, currentQuestion.explanation));
                optionsContainer.appendChild(button);
            }
            feedbackDisplay.classList.add('hidden');
        }

        async function checkAnswer(userAnswer, correctAnswer, explanation) {
            showGameLoading();
            Array.from(optionsContainer.children).forEach(btn => btn.disabled = true);

            questionsAnsweredCount++;

            if (userAnswer === correctAnswer) {
                currentAltitude += ALTITUDE_GAIN_PER_CORRECT_ANSWER;
                feedbackDisplay.classList.remove('bg-red-100', 'text-red-800');
                feedbackDisplay.classList.add('bg-green-100', 'text-green-800');
                feedbackDisplay.textContent = "Зөв хариуллаа! Та улам дээшилж байна.";
            } else {
                currentAltitude -= ALTITUDE_PENALTY_PER_INCORRECT_ANSWER;
                if (currentAltitude < 0) {
                    currentAltitude = 0;
                }
                feedbackDisplay.classList.remove('bg-green-100', 'text-green-800');
                feedbackDisplay.classList.add('bg-red-100', 'text-red-800');
                feedbackDisplay.textContent = `Буруу хариуллаа. Зөв хариулт нь: ${correctAnswer}. Тайлбар: ${explanation}`;
            }
            feedbackDisplay.classList.remove('hidden');
            updateDisplay();

            setTimeout(() => {
                if (questionsAnsweredCount >= QUESTIONS_TO_ASK) {
                    endGame();
                } else {
                    hideGameLoading();
                    displayQuestion();
                    Array.from(optionsContainer.children).forEach(btn => btn.disabled = false);
                }
            }, 2000);
        }

        async function saveGameResult(isWin, finalAltitude, studentClass, studentGroup) {
            if (!db || !currentUserId) {
                console.error("Firestore not initialized or user not authenticated. Cannot save data.");
                saveStatusDisplay.classList.remove('hidden', 'bg-green-100', 'text-green-800');
                saveStatusDisplay.classList.add('bg-red-100', 'text-red-800');
                saveStatusDisplay.textContent = "Үр дүнг хадгалах боломжгүй. Интернэт холболтоо шалгаад дахин оролдоно уу.";
                return;
            }

            saveStatusDisplay.classList.remove('hidden', 'bg-red-100', 'text-red-800');
            saveStatusDisplay.classList.add('bg-blue-100', 'text-blue-800');
            saveStatusDisplay.textContent = "Үр дүнг хадгалж байна...";

            try {
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/game_scores`), {
                    userId: currentUserId,
                    class: studentClass,
                    group: studentGroup,
                    finalAltitude: finalAltitude,
                    isWin: isWin,
                    timestamp: new Date()
                });
                console.log("Document written with ID: ", docRef.id);
                saveStatusDisplay.classList.remove('bg-blue-100', 'text-blue-800');
                saveStatusDisplay.classList.add('bg-green-100', 'text-green-800');
                saveStatusDisplay.textContent = "Таны үр дүн амжилттай хадгалагдлаа!";
                studentClassInput.value = '';
                studentGroupInput.value = '';
            } catch (e) {
                console.error("Error adding document: ", e);
                saveStatusDisplay.classList.remove('bg-blue-100', 'text-blue-800');
                saveStatusDisplay.classList.add('bg-red-100', 'text-red-800');
                saveStatusDisplay.textContent = "Үр дүнг хадгалахад алдаа гарлаа. Дахин оролдоно уу.";
            } finally {
                setTimeout(() => {
                    saveStatusDisplay.classList.add('hidden');
                }, 3000);
            }
        }

        function clearGameDisplay() {
            questionText.classList.remove('bg-green-200', 'text-green-900', 'bg-red-200', 'text-red-900');
            questionCountText.textContent = "";
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', startGame);

        // --- Chatbot Script ---
        const chatHistoryDiv = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const chatbotLoadingIndicator = document.getElementById('chatbot-loading-indicator');

        const API_KEY = "AIzaSyC47JGMbEnlubYvjWG51i2q9E19yy36qwQ";
        const MODEL_NAME = "gemini-2.5-flash-preview-05-20";

        async function fetchGeminiResponse(prompt, retries = 3, delay = 1000) {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < retries - 1) {
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                            continue;
                        }
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Unexpected API response structure or missing content.");
                    }
                } catch (error) {
                    console.error("Error fetching from Gemini API:", error);
                    if (i === retries - 1) throw error;
                }
            }
            return "Уучлаарай, хариулт өгөхөд алдаа гарлаа. Дахин оролдоно уу.";
        }

        function appendMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            if (sender === 'user') {
                messageDiv.classList.add('user-message');
            } else {
                messageDiv.classList.add('bot-message');
            }
            messageDiv.textContent = text;
            chatHistoryDiv.appendChild(messageDiv);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        async function sendMessage() {
            const userQuestion = userInput.value.trim();
            if (userQuestion === '') return;

            appendMessage('user', userQuestion);
            userInput.value = '';
            showChatbotLoading();

            try {
                const botResponse = await fetchGeminiResponse(userQuestion);
                appendMessage('bot', botResponse);
            } catch (error) {
                appendMessage('bot', "Уучлаарай, хариулт өгөхөд алдаа гарлаа. Дахин оролдоно уу.");
            } finally {
                hideChatbotLoading();
            }
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        function showChatbotLoading() {
            chatbotLoadingIndicator.classList.remove('hidden');
            sendButton.disabled = true;
            userInput.disabled = true;
        }

        function hideChatbotLoading() {
            chatbotLoadingIndicator.classList.add('hidden');
            sendButton.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        }

        // --- New: Assignment Submission with Firebase Storage ---
        async function handleAssignmentSubmission(lessonId) {
            const fileInput = document.getElementById(`assignment-file-${lessonId}`);
            const submissionStatusDiv = document.getElementById(`submission-status-${lessonId}`);
            
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                submissionStatusDiv.classList.remove('hidden', 'text-green-800');
                submissionStatusDiv.classList.add('text-red-800');
                submissionStatusDiv.textContent = "Файл сонгоно уу.";
                return;
            }

            if (!db || !storage || !currentUserId) {
                submissionStatusDiv.classList.remove('hidden', 'text-green-800');
                submissionStatusDiv.classList.add('text-red-800');
                submissionStatusDiv.textContent = "Үйлчилгээ бэлэн биш байна. Интернэт холболтоо шалгаад дахин оролдоно уу.";
                console.error("Firebase services not initialized or user not authenticated.");
                return;
            }

            const file = fileInput.files[0];
            const fileName = file.name;
            const timestamp = new Date().toISOString();
            const storagePath = `assignments/${appId}/${currentUserId}/${lessonId}/${timestamp}_${fileName}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);

            submissionStatusDiv.classList.remove('hidden', 'text-red-800', 'text-green-800');
            submissionStatusDiv.classList.add('text-blue-800');
            submissionStatusDiv.textContent = `Файлыг ${file.name} илгээж байна... (0%)`;

            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    submissionStatusDiv.textContent = `Файлыг ${file.name} илгээж байна... (${Math.round(progress)}%)`;
                },
                (error) => {
                    console.error("Файл илгээхэд алдаа гарлаа:", error);
                    submissionStatusDiv.classList.remove('text-blue-800');
                    submissionStatusDiv.classList.add('text-red-800');
                    submissionStatusDiv.textContent = `Файл илгээхэд алдаа гарлаа: ${error.message}`;
                },
                async () => {
                    try {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        console.log('Файл амжилттай илгээгдлээ, URL:', downloadURL);

                        await addDoc(collection(db, `artifacts/${appId}/public/data/assignments`), {
                            userId: currentUserId,
                            lessonId: lessonId,
                            fileName: fileName,
                            fileURL: downloadURL,
                            timestamp: new Date(),
                            class: document.getElementById('student-class').value || 'N/A',
                            group: document.getElementById('student-group').value || 'N/A'
                        });

                        submissionStatusDiv.classList.remove('text-blue-800');
                        submissionStatusDiv.classList.add('text-green-800');
                        submissionStatusDiv.textContent = `Даалгавар ${file.name} амжилттай хураагдлаа! Багш таны файлыг удахгүй шалгана.`;
                        fileInput.value = '';
                    } catch (error) {
                        console.error("Файлын URL-г хадгалахад эсвэл даалгаврын мэдээлэл нэмэхэд алдаа гарлаа:", error);
                        submissionStatusDiv.classList.remove('text-blue-800');
                        submissionStatusDiv.classList.add('text-red-800');
                        submissionStatusDiv.textContent = `Даалгавар хураахад алдаа гарлаа: ${error.message}`;
                    } finally {
                        setTimeout(() => {
                            submissionStatusDiv.classList.add('hidden');
                        }, 5000);
                    }
                }
            );
        }

        // --- TTS Implementation ---
        const playAboutTextButton = document.getElementById('play-about-text');
        const ttsLoadingIndicator = document.getElementById('tts-loading-indicator');
        const aboutTextElement = document.getElementById('about-text');

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;

            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.byteLength, true);
            writeString(view, 8, 'WAVE');

            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true);
            view.setUint16(32, numChannels * bytesPerSample, true);
            view.setUint16(34, 8 * bytesPerSample, true);

            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.byteLength, true);

            const blob = new Blob([wavHeader, pcmData], { type: 'audio/wav' });
            return blob;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        async function playAboutText() {
            const textToSpeak = aboutTextElement.textContent.trim();
            if (!textToSpeak) {
                console.warn("No text to speak in the 'About' section.");
                return;
            }

            ttsLoadingIndicator.classList.remove('hidden');
            playAboutTextButton.disabled = true;

            const payload = {
                contents: [{
                    parts: [{ text: textToSpeak }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Puck" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmArrayBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmArrayBuffer);

                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        ttsLoadingIndicator.classList.add('hidden');
                        playAboutTextButton.disabled = false;
                    };

                } else {
                    console.error("Unexpected audio data format or missing content:", result);
                    alert("Уучлаарай, дууг үүсгэхэд асуудал гарлаа.");
                }

            } catch (error) {
                console.error("Error playing TTS:", error);
                alert("Уучлаарай, дууг үүсгэхэд алдаа гарлаа: " + error.message);
            } finally {
                if (!playAboutTextButton.disabled) {
                    ttsLoadingIndicator.classList.add('hidden');
                    playAboutTextButton.disabled = false;
                }
            }
        }

        playAboutTextButton.addEventListener('click', playAboutText);

        // --- Game Results Display Script ---
        const gameResultsSection = document.getElementById('game-results-section');
        const gameResultsBody = document.getElementById('game-results-body');
        const totalGamesPlayedSpan = document.getElementById('total-games-played');
        const averageScoreSpan = document.getElementById('average-score');
        const highestScoreSpan = document.getElementById('highest-score');
        const gameResultsLoadingIndicator = document.getElementById('game-results-loading-indicator');
        const gameResultsErrorMessage = document.getElementById('game-results-error-message');


        async function loadGameResults() {
            if (!db) {
                console.error("Firestore not initialized. Cannot load game results.");
                gameResultsErrorMessage.classList.remove('hidden');
                gameResultsErrorMessage.textContent = "Мэдээллийн сантай холбогдох боломжгүй байна. Дахин оролдоно уу.";
                return;
            }

            gameResultsBody.innerHTML = '';
            gameResultsLoadingIndicator.classList.remove('hidden');
            gameResultsErrorMessage.classList.add('hidden');

            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/game_scores`));
                const querySnapshot = await getDocs(q);

                let totalScore = 0;
                let highestScore = 0;
                let games = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    games.push(data);
                    totalScore += data.finalAltitude;
                    if (data.finalAltitude > highestScore) {
                        highestScore = data.finalAltitude;
                    }
                });

                games.sort((a, b) => b.timestamp.toDate().getTime() - a.timestamp.toDate().getTime());

                totalGamesPlayedSpan.textContent = games.length;
                averageScoreSpan.textContent = games.length > 0 ? (totalScore / games.length).toFixed(2) : '0';
                highestScoreSpan.textContent = highestScore;

                if (games.length === 0) {
                    gameResultsBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Одоогоор тоглоомын үр дүн байхгүй байна. Тоглож эхний үр дүнгээ бүртгүүлээрэй!</td></tr>`;
                } else {
                    games.forEach((data) => {
                        const row = gameResultsBody.insertRow();
                        row.classList.add('hover:bg-gray-100');
                        
                        const userIdCell = row.insertCell();
                        userIdCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900');
                        userIdCell.textContent = data.userId ? data.userId.substring(0, 8) + '...' : 'Unknown';

                        const classCell = row.insertCell();
                        classCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
                        classCell.textContent = data.class || 'N/A';

                        const groupCell = row.insertCell();
                        groupCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
                        groupCell.textContent = data.group || 'N/A';

                        const scoreCell = row.insertCell();
                        scoreCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
                        scoreCell.textContent = `${data.finalAltitude} м`;

                        const resultCell = row.insertCell();
                        resultCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-semibold');
                        resultCell.textContent = data.isWin ? 'Ялалт' : 'Ялагдал';
                        resultCell.classList.add(data.isWin ? 'text-green-600' : 'text-red-600');

                        const dateCell = row.insertCell();
                        dateCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
                        dateCell.textContent = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A';
                    });
                }
            } catch (error) {
                console.error("Error loading game results:", error);
                gameResultsErrorMessage.classList.remove('hidden');
                gameResultsErrorMessage.textContent = `Үр дүнгүүдийг ачаалахад алдаа гарлаа: ${error.message}`;
            } finally {
                gameResultsLoadingIndicator.classList.add('hidden');
            }
        }
    </script>
</body>
</html>

